# 上位机软件最终方案

<br>

## 一、通信协议

**采用tcp协议进行传输**

### 1.1 设备机向上位机发送的数据部分格式如下

存储顺序|名称|位宽|数据类型
:-|:-|:-|:-
1|设备唯一标识符|6个字节|字符串类型
2|消息类型|2个字节|字符串类型
3|消息内容|8或16或24个字节|字符串类型

上位机向设备机发送的数据部分要么个字节，要么(6+2+8+8)个字节。

### 1.2 各字段详细介绍

**1.设备唯一标识符**

在设备首次登录时确定，以后每次登录自动读取，并发送给上位机。(设备机器开发)

**2.消息类型和存储内容分为：**

类型|名称|解释|消息总长
:-:|:-|:-|:-
"01"|登录消息|上位机接收后根据消息的前6个字符获取登录机器的id|8(6+2)个字节。
"02"|数据(α或γ)消息|如果是来自A设备的那就是α值；如果来自B设备，那就是γ|16(6+2+8)个字节。
"03"|数据β和水位消息|只可能来自设备B，包含β和水位信息|24(6+2+8+8)个字节。
"04"|α请求消息|由上位机发给设备A，A设备收到后才会 **继续工作**。工作结束发送α(即消息类型02)给上位机|2个字节。
"05"|最终校准值消息|A设备收到后取出最终值进行调整, **不工作**|10(2+8)个字节。
"06"|β请求消息|由上位机发给设备B，B设备收到后发送β初值和水位信息(即消息类型03)给上位机|2个字节。
"07"|γ请求消息|当上位机收到α值后发给设备B，B设备收到后发送γ末值(即消息类型02)给上位机|2个字节。
"08"|精度稳定返回值|精度调试step稳定后返回给A设备,包括**新的VS1、VS2和引流系数**|26(2+8+8+8)个字节。

**3.数据**

- 可见所有的数据都是8个字节存储。
- 格式为:  `XXXX.XXX`
- 可表示的范围为`0000.000`至`9999.999`

### 1.3 消息示例

例如：
1. `AB123401` 代表一条登录消息，设备是AB1234
2. `AB0001020045.710` 代表设备AB0001发来的类型为02的数据消息，数据是45.71
3. `AB0011039876.5001000.000` 代表设备AB0011发来的类型为03的数据β和水位消息，数据β是9876.5， 水位是1000
4. `058888.123` 该消息是由上位机发送给设备A，设备A收到后通过检测前两个字节是05得知是校准值消息，从而取出8888.123进行校准。



## 二、软件执行流程

### 2.1 VS1流程简述：

1. 上位机 向 设备B 发送β请求
2. 设备B 向 上位机 发送β和水位信息 
3. (上位机检测水位，并根据不同的情况做出不同的响应)
4. 上位机 向 设备A 发送α请求
5. (设备A收到后开始工作一段时间)
6. 设备A 向 上位机 发送α
7. 上位机 向 设备B 发送γ请求
8. 设备B 向 上位机 发送γ
9. 此阶段分三种情况：
	- 如果此时是第一个周期，则根据公式得出的调整值直接作为最终值，最终值不返回给A。回到第一步。
	- 如果此时是第二个周期，则根据公式得出的调整值和上一个周期的调整值求平均作为最终值，最终值返回给设备A。回到第一步。
	- 如果此时是第三个周期，则根据公式得出的调整值和当前周期的原值比较，并做出结论。VS1调试结束。


### 2.2 流程详细介绍：

1. 开启上位机软件，监听局域网的某个端口（默认8888）。
2. 多个设备机登录，上线后向上位机发送登录指令(指令类型01)。
3. 设备机收到后更新列表信息。如果该设备已经绑定则提示某设备组的某设备上线，如果未绑定设备组则提示并增加到未绑定设备列表中。
4. 此时可以通过点击开始调试进行任意设备组的VS1或VS2或精度调试。如果此时其他调试工作还未完成，会有警告，如果强制中断则会进行所选的调试模式。
5. VS调试中默认的VS1和VS2值取默认值x(乙方给定)。
6. 若进行VS1调试。
	1. 则会向当前设备组的设备B发起请求，消息类型为"06",直到收到消息类型为"03"的消息，同时检测此时的水位信息，如果水位低于一定阈值则发出警告消息。提醒工作人员及时解决。
	2. 解决好后点击继续调试即可。此时会再次向B发起请求，消息类型为"06",重复上述工作，再次解析来自设备B的消息类型为"03"的消息。
	3. 而如果水位正常，则会向设备A发送α请求，消息类型为"04"，A收到后开始工作，工作一段时间结束后发送α给上位机软件。
	4. 上位机软件收到后向设备B发送γ请求，消息类型为"07"，等待设备B发来γ，待收到γ后根据相关公式计算出调整值。
		- 如果是一轮调试的第一次，则最终值就是调整值，本次最终值结果不返回给设备A。
		- 如果当前次数是一轮调试的第二次，则会根据上一次的调整值求平均得出最终值，此时最终值结果需要返回给设备A，消息类型为"05"，让设备A根据最终值做出调整，但此时并不会继续工作。
		- 求出最终值后即开始下一次的数据传输，首先上位机会向设备B发起β请求，消息类型为"06",即回到第一步，重复此过程，直到第三次结束。
		- 第三次结束时会计算α值与调整值的距离，若差距过大则做出警告，并在表格中做个备注，正常差距则自动进行VS2调试。

**VS2调试步骤和VS1一致。不再重述。**


### 2.3 精度调试大致流程（尚未讨论精度调试的具体规则）

具体规则见文件**"精度调试计算与流程"**。

<br>
<br>


## 三、实现的功能

#### 设备组

1. 指定任意两个设备进行绑定
2. 通过鼠标拖拽快捷解绑任意个设备组
3. 收发数据的动作会显示在下方日志中和左侧对应的设备组列表中
4. 通过设备组列表切换设备组

#### TCP通信

1. 监听指定IP和端口
2. 通过多线程支持与多台设备同时通信
3. 允许设备意外掉线后再次连接

#### 调试

1. 点击启动VS1调试，VS1稳定后自动进行VS2调试。
2. 在精度调试之前可以改变引流系数、阈值和范围边界。
3. 精度调试不稳定会显示红色警告。

#### 公式：

1. 增删VS公式
2. 公式格式合法性检测
3. 运行时公式出错检测(例如除数为零)

#### 表格:

1. 保存当前设备的当前调试模式的结果到execl表格
2. 增加背景色区分VS1和VS2

#### 额外功能：

1. 多种主题支持
2. 增删工作人员
3. 定制默认表格存储路径
4. 定制默认参数
5. 退出时保存,启动时恢复.(最新的工作人员和公式列表，当前的工作人员，当前设备组绑定关系和当前使用的VS公式)
6. 当检测到设备B缺水，红色警告，并终止当前设备组调试。
7. 允许调试时任意时刻中止当前调试。
8. 当精度不稳时显示红色警告并终止。



