# 上位机软件通信协议

<br>

**采用tcp协议进行传输**

### 1.1 设备机向上位机发送的数据部分格式如下

存储顺序|名称|位宽|数据类型
:-|:-|:-|:-
1|设备唯一标识符|6个字节|字符串类型
2|消息类型|2个字节|字符串类型
3|消息内容|8或16或24个字节|字符串类型

上位机向设备机发送的数据部分要么个字节，要么(6+2+8+8)个字节。

### 1.2 各字段详细介绍

**1.设备唯一标识符**

在设备首次登录时确定，以后每次登录自动读取，并发送给上位机。(设备机器开发)

**2.消息类型和存储内容分为：**

类型|名称|解释|消息总长
:-:|:-|:-|:-
"01"|登录消息|上位机接收后根据消息的前6个字符获取登录机器的id|8(6+2)个字节。
"02"|数据(α或γ)消息|如果是来自A设备的那就是α值；如果来自B设备，那就是γ|16(6+2+8)个字节。
"03"|数据β和水位消息|只可能来自设备B，包含β和水位信息|24(6+2+8+8)个字节。
"04"|α请求消息,精度模式|由上位机发给设备A，A设备收到后才会 **继续工作**。工作结束发送α(即消息类型02)给上位机|2个字节。
"14"|α请求消息,VS1模式|由上位机发给设备A，A设备收到后才会 **继续工作**。工作结束发送α(即消息类型02)给上位机|2个字节。
"24"|α请求消息,VS2模式|由上位机发给设备A，A设备收到后才会 **继续工作**。工作结束发送α(即消息类型02)给上位机|2个字节。
"05"|最终校准值消息|A设备收到后取出最终值进行调整, **不工作**|10(2+8)个字节。
"15"|VS1调试通知指令，通知VS1原值消息|A设备收到后取出VS1原值消息，回复确认|10(2+8)个字节。
"25"|VS2调试通知指令，通知VS2原值消息|A设备收到后取出VS2原值消息，回复确认|10(2+8)个字节。
"35"|VS1补充指令|A设备收到后,回复补充确认，**准备工作**|2个字节。
"45"|VS2补充指令|A设备收到后,回复补充确认，**准备工作**|2个字节。
"80"|补充确认指令 或 新一轮通知确认(精度模式)|上位机收到后开始请求β,进行新的一轮|2个字节。
"06"|β请求消息|由上位机发给设备B，B设备收到后发送β初值和水位信息(即消息类型03)给上位机|2个字节。
"07"|γ请求消息|当上位机收到α值后发给设备B，B设备收到后发送γ末值(即消息类型02)给上位机|2个字节。
"08"|精度稳定返回值 并且也是 新一轮通知(精度模式)|精度调试step稳定后返回给A设备,包括**新的VS1、VS2和引流系数**|26(2+8+8+8)个字节。
"18"|精度调试ok通知|精度调试ok稳定后返回给A设备|2个字节。
"65"|精度调试通知指令，精度调试参数通知|精度调试开始时返回给A设备,包括**初始的VS1、VS2和引流系数**|26(2+8+8+8)个字节。
"55"|回应确认消息|设备A收到调试通知指令后回复给上位机，开始调试|2个字节。
"11"|精度调试通知|通知设备A转化为精度调试|2个字节。
"91"|中止通知|通知设备A调试中止|2个字节。
"16"|新一轮通知|上位机通知设备A准备新一轮|2个字节。

**3.数据**

- 可见所有的数据都是8个字节存储。
- 格式为:  `XXXX.XXX`
- 可表示的范围为`0000.000`至`9999.999`

### 1.3 消息示例

例如：
1. `AB123401` 代表一条登录消息，设备是AB1234
2. `AB0001020045.710` 代表设备AB0001发来的类型为02的数据消息，数据是45.71
3. `AB0011039876.5001000.000` 代表设备AB0011发来的类型为03的数据β和水位消息，数据β是9876.5， 水位是1000
4. `058888.123` 该消息是由上位机发送给设备A，设备A收到后通过检测前两个字节是05得知是校准值消息，从而取出8888.123进行校准。


